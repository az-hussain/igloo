#!/bin/bash
set -euo pipefail

IGLOO_DIR="$(cd "$(dirname "$0")" && pwd)"
LAUNCH_DIR="$HOME/Library/LaunchAgents"
HEARTBEAT_PLIST="com.igloo.heartbeat.plist"
LISTENER_PID_FILE="$IGLOO_DIR/daemon/listener.pid"

usage() {
    echo "Usage: igloo <command>"
    echo ""
    echo "Commands:"
    echo "  start     Setup (if needed) + start daemons + bootstrap"
    echo "  stop      Stop heartbeat and listener"
    echo "  restart   Restart daemons"
    echo "  status    Show daemon status"
    echo "  logs      Tail daemon logs"
    echo "  chat      Start interactive Claude session"
    echo ""
}

# ── Setup (runs once, idempotent) ────────────────────────────────────────────

do_setup() {
    echo "Running first-time setup..."
    echo ""

    # Check dependencies
    local missing=false
    for cmd_info in "claude:Claude Code:npm install -g @anthropic-ai/claude-code" \
                    "node:Node.js:https://nodejs.org" \
                    "git:Git:xcode-select --install" \
                    "imsg:imsg:brew install steipete/tap/imsg" \
                    "gog:gog:brew install gogcli/tap/gog"; do
        IFS=: read -r cmd name hint <<< "$cmd_info"
        if command -v "$cmd" &>/dev/null; then
            echo "  [ok] $name"
        else
            echo "  [!!] $name not found — $hint"
            missing=true
        fi
    done
    echo ""

    if [ "$missing" = true ]; then
        read -p "Some dependencies are missing. Continue anyway? (y/N) " -n 1 -r
        echo ""
        [[ $REPLY =~ ^[Yy]$ ]] || exit 1
    fi

    # Create directories
    mkdir -p "$IGLOO_DIR"/{memory,tasks,workspace,.claude}
    touch "$IGLOO_DIR/memory/.gitkeep" "$IGLOO_DIR/tasks/.gitkeep" "$IGLOO_DIR/workspace/.gitkeep"

    # Install MCP dependencies
    echo "Installing MCP server dependencies..."
    (cd "$IGLOO_DIR/mcp" && npm install --silent 2>/dev/null)

    # Detect paths
    local homebrew_prefix
    homebrew_prefix="$(brew --prefix 2>/dev/null || echo "/opt/homebrew")"

    # Generate configs from templates
    echo "Generating configuration..."
    sed -e "s|__IGLOO_DIR__|$IGLOO_DIR|g" \
        "$IGLOO_DIR/mcp/mcp-config.json.template" > "$IGLOO_DIR/mcp/mcp-config.json"

    sed -e "s|__IGLOO_DIR__|$IGLOO_DIR|g" \
        -e "s|__HOME__|$HOME|g" \
        -e "s|__HOMEBREW_PREFIX__|$homebrew_prefix|g" \
        "$IGLOO_DIR/daemon/com.igloo.heartbeat.plist.template" > "$IGLOO_DIR/daemon/$HEARTBEAT_PLIST"

    sed -e "s|__IGLOO_DIR__|$IGLOO_DIR|g" \
        "$IGLOO_DIR/.claude/settings.json.template" > "$IGLOO_DIR/.claude/settings.json"

    echo '[]' > "$IGLOO_DIR/.claude/allowed-senders.json"

    cp "$IGLOO_DIR/core/TOOLS.md.example" "$IGLOO_DIR/core/TOOLS.md"
    sed -i '' "s|\[filled by setup.sh\]|$IGLOO_DIR|g" "$IGLOO_DIR/core/TOOLS.md"

    chmod +x "$IGLOO_DIR/daemon/heartbeat.sh" "$IGLOO_DIR/daemon/listener.sh"

    # Init git if needed
    if [ ! -d "$IGLOO_DIR/.git" ]; then
        (cd "$IGLOO_DIR" && git init --quiet)
    fi
    (cd "$IGLOO_DIR" && git add -A && git commit -m "Igloo: initial setup" --quiet 2>/dev/null || true)

    echo ""
    echo "  Setup complete."
}

# ── Listener (background process, inherits Terminal FDA) ─────────────────────

listener_stop() {
    if [ -f "$LISTENER_PID_FILE" ]; then
        local pid
        pid=$(cat "$LISTENER_PID_FILE")
        if kill -0 "$pid" 2>/dev/null; then
            kill "$pid" 2>/dev/null
            echo "  Listener stopped (pid $pid)"
        else
            echo "  Listener not running (stale pid)"
        fi
        rm -f "$LISTENER_PID_FILE"
    else
        echo "  Listener not running"
    fi
}

listener_start() {
    listener_stop 2>/dev/null

    nohup node "$IGLOO_DIR/daemon/listener.js" \
        >> "$IGLOO_DIR/daemon/listener.log" 2>&1 &
    local pid=$!
    echo "$pid" > "$LISTENER_PID_FILE"
    echo "  Listener started (pid $pid, real-time iMessage)"
}

listener_status() {
    if [ -f "$LISTENER_PID_FILE" ] && kill -0 "$(cat "$LISTENER_PID_FILE")" 2>/dev/null; then
        echo "  Listener:  running (pid $(cat "$LISTENER_PID_FILE"))"
    else
        echo "  Listener:  stopped"
    fi
}

# ── Daemon management ────────────────────────────────────────────────────────

do_stop() {
    # Heartbeat (LaunchAgent)
    launchctl unload "$LAUNCH_DIR/$HEARTBEAT_PLIST" 2>/dev/null && echo "  Heartbeat stopped" || echo "  Heartbeat not running"
    # Listener (background process)
    listener_stop
}

do_start() {
    # Run setup if not done yet
    if [ ! -f "$IGLOO_DIR/.claude/settings.json" ]; then
        do_setup
    fi

    # Heartbeat (LaunchAgent — doesn't need FDA)
    launchctl unload "$LAUNCH_DIR/$HEARTBEAT_PLIST" 2>/dev/null || true
    mkdir -p "$LAUNCH_DIR"
    cp "$IGLOO_DIR/daemon/$HEARTBEAT_PLIST" "$LAUNCH_DIR/"
    launchctl load "$LAUNCH_DIR/$HEARTBEAT_PLIST"
    echo "  Heartbeat started (every 30 min)"

    # Listener (background process — needs Terminal FDA for chat.db)
    listener_start

    # Bootstrap if not done yet
    if [ ! -f "$IGLOO_DIR/memory/MEMORY.md" ]; then
        echo ""
        echo "  First run detected — launching interactive bootstrap..."
        echo ""
        cd "$IGLOO_DIR"
        claude --dangerously-skip-permissions "Hi! I just set up Igloo. This is your first run - bootstrap me."
    fi
}

do_status() {
    echo "Daemons:"
    if launchctl list 2>/dev/null | grep -q com.igloo.heartbeat; then
        echo "  Heartbeat: running"
    else
        echo "  Heartbeat: stopped"
    fi
    listener_status
    echo ""
    echo "Logs:"
    for log in "$IGLOO_DIR/daemon/"*.log; do
        if [ -f "$log" ]; then
            echo "  $(basename "$log"): $(wc -l < "$log" | tr -d ' ') lines, $(du -h "$log" | cut -f1)"
        fi
    done
}

do_logs() {
    tail -f "$IGLOO_DIR/daemon/"*.log
}

do_chat() {
    cd "$IGLOO_DIR"
    claude --dangerously-skip-permissions "$@"
}

# ── Main ─────────────────────────────────────────────────────────────────────

case "${1:-}" in
    start)   do_start ;;
    stop)    do_stop ;;
    restart) do_stop; sleep 1; do_start ;;
    status)  do_status ;;
    logs)    do_logs ;;
    chat)    shift; do_chat "$@" ;;
    setup)   do_setup ;;
    *)       usage ;;
esac
