#!/bin/bash
set -euo pipefail

# Resolve symlinks to find the real code directory
SOURCE="$0"
while [ -L "$SOURCE" ]; do
    DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    # If SOURCE is relative, resolve it relative to the symlink's directory
    [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
done
CODE_DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
IGLOO_HOME="${IGLOO_HOME:-$HOME/.igloo}"

# ── Helpers ───────────────────────────────────────────────────────────────────

# Copy file from CODE_DIR to IGLOO_HOME only if destination doesn't exist
seed_file() {
    local src="$CODE_DIR/$1"
    local dst="$IGLOO_HOME/$2"
    if [ ! -f "$dst" ] && [ -f "$src" ]; then
        cp "$src" "$dst"
    fi
}

# Generate configs from templates (shared by setup + upgrade)
generate_configs() {
    local node_path
    node_path="$(command -v node)"

    # .claude/settings.json
    sed -e "s|__CODE_DIR__|$CODE_DIR|g" \
        -e "s|__IGLOO_HOME__|$IGLOO_HOME|g" \
        -e "s|__NODE_PATH__|$node_path|g" \
        "$CODE_DIR/.claude/settings.json.template" > "$IGLOO_HOME/.claude/settings.json"

    # .mcp.json — auto-discovered by Claude Code when running from IGLOO_HOME
    sed -e "s|__CODE_DIR__|$CODE_DIR|g" \
        -e "s|__NODE_PATH__|$node_path|g" \
        "$CODE_DIR/mcp/.mcp.json.template" > "$IGLOO_HOME/.mcp.json"

    # core/TOOLS.md
    sed -e "s|__CODE_DIR__|$CODE_DIR|g" \
        -e "s|__IGLOO_HOME__|$IGLOO_HOME|g" \
        "$CODE_DIR/core/TOOLS.md.template" > "$IGLOO_HOME/core/TOOLS.md"
}

get_session_id() {
    if [ -f "$IGLOO_HOME/.claude/session-id" ]; then
        cat "$IGLOO_HOME/.claude/session-id"
    fi
}

# Check if a tool is enabled in .claude/tools.json
tool_enabled() {
    local tool="$1"
    local tools_file="$IGLOO_HOME/.claude/tools.json"
    if [ -f "$tools_file" ]; then
        [ "$(jq -r ".$tool.enabled" "$tools_file" 2>/dev/null)" = "true" ]
    else
        return 1
    fi
}

# Rotate a log file to .log.old if > 1MB
rotate_log() {
    local log_file="$1"
    if [ -f "$log_file" ] && [ "$(stat -f%z "$log_file" 2>/dev/null || echo 0)" -gt 1048576 ]; then
        mv "$log_file" "$log_file.old"
    fi
}

# Build context injection string from core files (for fresh sessions)
build_context() {
    local ctx=""
    for f in "$IGLOO_HOME/core/SOUL.md" "$IGLOO_HOME/core/USER.md" "$IGLOO_HOME/memory/MEMORY.md"; do
        if [ -f "$f" ]; then
            ctx+="$(cat "$f")"$'\n\n'
        fi
    done
    if [ -n "$ctx" ]; then
        echo "[Context]"$'\n'"$ctx""[End Context]"$'\n'
    fi
}

banner() {
    local version="unknown"
    if [ -f "$CODE_DIR/VERSION" ]; then
        version=$(cat "$CODE_DIR/VERSION")
    fi
    cat << EOF
        ___
      /|_|_|\\           igloo v${version}
     |_|_|_|_|          A Home for Claude Code
     |_|   |_|          ${IGLOO_HOME/#$HOME/~}
        ‾‾‾
EOF
}

usage() {
    banner
    echo "Usage: igloo [command] [flags]"
    echo ""
    echo "  igloo                Start session (in current dir, or home if in IGLOO_HOME)"
    echo "  igloo --home         Force session from igloo home directory"
    echo "  igloo --danger       Start session with permissions bypassed"
    echo ""
    echo "Commands:"
    echo "  meeting   Record a meeting transcript and generate notes"
    echo "  start     Setup (if needed) + start daemons + bootstrap"
    echo "  stop      Stop listener daemon"
    echo "  restart   Restart daemons"
    echo "  status    Show daemon status"
    echo "  logs      Tail daemon logs"
    echo "  upgrade   Pull latest code, update configs, restart"
    echo "  connect   Grant another user access (connect <username>)"
    echo "  version   Show version and paths"
    echo "  help      Show this help"
    echo ""
}

# ── Setup (runs once, idempotent) ────────────────────────────────────────────

do_setup() {
    echo "Running first-time setup..."
    echo ""

    # Check dependencies
    local missing=false
    for cmd_info in "claude:Claude Code:npm install -g @anthropic-ai/claude-code" \
                    "node:Node.js:https://nodejs.org" \
                    "git:Git:xcode-select --install" \
                    "imsg:imsg:brew install steipete/tap/imsg"; do
        IFS=: read -r cmd name hint <<< "$cmd_info"
        if command -v "$cmd" &>/dev/null; then
            echo "  [ok] $name"
        else
            echo "  [!!] $name not found — $hint"
            missing=true
        fi
    done
    echo ""

    if [ "$missing" = true ]; then
        read -p "Some dependencies are missing. Continue anyway? (y/N) " -n 1 -r
        echo ""
        [[ $REPLY =~ ^[Yy]$ ]] || exit 1
    fi

    # Create IGLOO_HOME directory structure
    mkdir -p "$IGLOO_HOME/.claude/skills"
    mkdir -p "$IGLOO_HOME/core"
    mkdir -p "$IGLOO_HOME/memory/meetings"
    mkdir -p "$IGLOO_HOME/tasks"
    mkdir -p "$IGLOO_HOME/workspace"
    mkdir -p "$IGLOO_HOME/daemon"
    mkdir -p "$IGLOO_HOME/intake"
    mkdir -p "$IGLOO_HOME/transcripts"

    # Install dependencies in CODE_DIR
    echo "Installing dependencies..."
    (cd "$CODE_DIR/mcp" && npm install --silent 2>/dev/null)
    (cd "$CODE_DIR/scripts" && npm install --silent 2>/dev/null)
    (cd "$CODE_DIR/daemon" && npm install --silent 2>/dev/null)

    # Copy CLAUDE.md (always overwrite — it's system-managed)
    echo "Generating configuration..."
    cp "$CODE_DIR/CLAUDE.md" "$IGLOO_HOME/CLAUDE.md"

    # Generate configs from templates
    generate_configs

    # Seed state files (copy-if-not-exists)
    seed_file "core/HEARTBEAT.md.default" "core/HEARTBEAT.md"
    seed_file "core/schedules.json.default" "core/schedules.json"

    # Seed default skills
    if [ -d "$CODE_DIR/core/skills/process-meeting" ] && [ ! -d "$IGLOO_HOME/.claude/skills/process-meeting" ]; then
        mkdir -p "$IGLOO_HOME/.claude/skills/process-meeting"
        cp "$CODE_DIR/core/skills/process-meeting/SKILL.md" "$IGLOO_HOME/.claude/skills/process-meeting/SKILL.md"
    fi

    # Seed tasks and workspace index
    if [ ! -f "$IGLOO_HOME/tasks/TASKS.md" ]; then
        cat > "$IGLOO_HOME/tasks/TASKS.md" << 'TASKEOF'
# Tasks

## Active


## Completed

TASKEOF
    fi

    if [ ! -f "$IGLOO_HOME/workspace/INDEX.md" ]; then
        cat > "$IGLOO_HOME/workspace/INDEX.md" << 'IDXEOF'
# Workspace Index

When you create a new project folder in `workspace/`, add an entry here.

| Folder | Description | Created |
|--------|-------------|---------|
IDXEOF
    fi

    # Generate persistent session ID
    if [ ! -f "$IGLOO_HOME/.claude/session-id" ]; then
        uuidgen | tr '[:upper:]' '[:lower:]' > "$IGLOO_HOME/.claude/session-id"
    fi

    # Symlink igloo to PATH
    local bin_dir="$HOME/.local/bin"
    if [ -L "$bin_dir/igloo" ]; then
        echo "  [ok] igloo already on PATH"
    elif [ -e "$bin_dir/igloo" ]; then
        echo "  [ok] igloo already on PATH (not a symlink)"
    else
        mkdir -p "$bin_dir"
        ln -s "$CODE_DIR/igloo" "$bin_dir/igloo"
        echo "  [ok] Symlinked igloo → $bin_dir/igloo"
        # Ensure ~/.local/bin is on PATH
        if ! echo "$PATH" | tr ':' '\n' | grep -q "^$bin_dir$"; then
            local shell_rc="$HOME/.zshrc"
            local login_shell
            login_shell=$(basename "$(dscl . -read "/Users/$(whoami)" UserShell 2>/dev/null | awk '{print $2}')" 2>/dev/null || echo "zsh")
            if [ "$login_shell" = "bash" ]; then
                shell_rc="$HOME/.bashrc"
            fi
            if ! grep -q "$bin_dir" "$shell_rc" 2>/dev/null; then
                echo "export PATH=\"$bin_dir:\$PATH\"" >> "$shell_rc"
                echo "  [ok] Added $bin_dir to PATH in $(basename "$shell_rc")"
            fi
        fi
    fi

    # Store CODE_DIR reference and version
    echo "$CODE_DIR" > "$IGLOO_HOME/.igloo-code-dir"
    if [ -f "$CODE_DIR/VERSION" ]; then
        cp "$CODE_DIR/VERSION" "$IGLOO_HOME/.igloo-version"
    fi

    # Init git in IGLOO_HOME if needed
    if [ ! -d "$IGLOO_HOME/.git" ]; then
        (cd "$IGLOO_HOME" && git init --quiet)

        # Generate .gitignore for home directory
        cat > "$IGLOO_HOME/.gitignore" << 'GIEOF'
# Generated configs (regenerated on setup/upgrade)
.claude/settings.json
.mcp.json
core/TOOLS.md
CLAUDE.md

# Runtime
daemon/*.log
daemon/*.log.old
daemon/*.pid
.claude/scheduler-state.json
intake/.last-meeting.json

# System
.igloo-code-dir
.igloo-version
.DS_Store
GIEOF
    fi
    (cd "$IGLOO_HOME" && git add -A && git commit -m "Igloo: initial setup" --quiet 2>/dev/null || true)

    # Copy BOOTSTRAP.md if it exists (triggers first-run flow)
    seed_file "core/BOOTSTRAP.md" "core/BOOTSTRAP.md"

    echo ""
    echo "  Setup complete. Home: $IGLOO_HOME"
}

# ── Listener (background process, inherits Terminal FDA) ─────────────────────

listener_stop() {
    local pid_file="$IGLOO_HOME/daemon/listener.pid"
    if [ -f "$pid_file" ]; then
        local pid
        pid=$(cat "$pid_file")
        if kill -0 "$pid" 2>/dev/null; then
            kill "$pid" 2>/dev/null
            echo "  Listener stopped (pid $pid)"
        else
            echo "  Listener not running (stale pid)"
        fi
        rm -f "$pid_file"
    else
        echo "  Listener not running"
    fi
}

listener_start() {
    listener_stop 2>/dev/null

    rotate_log "$IGLOO_HOME/daemon/listener.log"

    IGLOO_HOME="$IGLOO_HOME" CODE_DIR="$CODE_DIR" \
        nohup node "$CODE_DIR/daemon/listener.js" \
        >> "$IGLOO_HOME/daemon/listener.log" 2>&1 &
    local pid=$!
    echo "$pid" > "$IGLOO_HOME/daemon/listener.pid"
    echo "  Listener started (pid $pid, scheduler + iMessage)"
}

listener_status() {
    local pid_file="$IGLOO_HOME/daemon/listener.pid"
    if [ -f "$pid_file" ] && kill -0 "$(cat "$pid_file")" 2>/dev/null; then
        echo "  Listener:  running (pid $(cat "$pid_file"))"
    else
        echo "  Listener:  stopped"
    fi
}

# ── Daemon management ────────────────────────────────────────────────────────

do_stop() {
    listener_stop
}

do_start() {
    # Run setup if not done yet
    if [ ! -f "$IGLOO_HOME/.claude/settings.json" ]; then
        do_setup
    fi

    local is_bootstrap=false

    # First run: CLI onboarding — collect info, test tools, write configs
    if [ -f "$IGLOO_HOME/core/BOOTSTRAP.md" ]; then
        is_bootstrap=true
        IGLOO_HOME="$IGLOO_HOME" CODE_DIR="$CODE_DIR" node "$CODE_DIR/scripts/setup.js"
    fi

    # Start daemons (scheduler always, iMessage if enabled by setup)
    rotate_log "$IGLOO_HOME/daemon/listener.log"
    listener_start

    # Bootstrap: first conversation with the agent (daemons already running)
    if [ "$is_bootstrap" = true ]; then
        cd "$IGLOO_HOME"
        local sid
        sid=$(get_session_id)
        claude --session-id "$sid" --chrome \
            --mcp-config "$CODE_DIR/mcp/mcp-config.json" \
            "You've just been configured via the setup wizard. Read core/BOOTSTRAP.md and follow its instructions."

        rm -f "$IGLOO_HOME/core/BOOTSTRAP.md"
        (cd "$IGLOO_HOME" && git add -A && git commit -m "Bootstrap complete — removed BOOTSTRAP.md" --quiet 2>/dev/null || true)
    fi

    echo ""
    echo "  Run 'igloo status' to check on things."
}

format_relative_time() {
    local seconds=$1
    if [ "$seconds" -lt 60 ]; then
        echo "${seconds}s ago"
    elif [ "$seconds" -lt 3600 ]; then
        echo "$(( seconds / 60 ))m ago"
    elif [ "$seconds" -lt 86400 ]; then
        echo "$(( seconds / 3600 ))h ago"
    else
        echo "$(( seconds / 86400 ))d ago"
    fi
}

do_status() {
    banner
    echo ""

    # Daemon status
    local pid_file="$IGLOO_HOME/daemon/listener.pid"
    if [ -f "$pid_file" ] && kill -0 "$(cat "$pid_file")" 2>/dev/null; then
        echo "Daemon:    running (pid $(cat "$pid_file"))"
    else
        echo "Daemon:    stopped"
    fi
    echo ""

    # Tools
    local tools_file="$IGLOO_HOME/.claude/tools.json"
    if [ -f "$tools_file" ]; then
        echo "Tools:"
        local keys
        keys=$(jq -r 'keys[]' "$tools_file" 2>/dev/null)
        if [ -n "$keys" ]; then
            while IFS= read -r key; do
                local enabled status
                enabled=$(jq -r ".[\"$key\"].enabled" "$tools_file" 2>/dev/null)
                status=$(jq -r ".[\"$key\"].status" "$tools_file" 2>/dev/null)
                if [ "$enabled" = "true" ]; then
                    printf "  %-12s %s\n" "$key" "$status"
                else
                    printf "  %-12s %s\n" "$key" "disabled"
                fi
            done <<< "$keys"
        else
            echo "  none configured"
        fi
        echo ""
    fi

    # Schedules
    local schedules_file="$IGLOO_HOME/core/schedules.json"
    local state_file="$IGLOO_HOME/.claude/scheduler-state.json"
    if [ -f "$schedules_file" ]; then
        local count
        count=$(jq 'length' "$schedules_file" 2>/dev/null || echo "0")
        if [ "$count" -gt 0 ]; then
            echo "Schedules:"
            local now_s
            now_s=$(date +%s)
            jq -r '.[] | "\(.id)\t\(.cron)\t\(.enabled)"' "$schedules_file" 2>/dev/null | while IFS=$'\t' read -r id cron enabled; do
                local last_info="never"
                if [ -f "$state_file" ]; then
                    local last_ms last_status last_dur_ms
                    last_ms=$(jq -r ".[\"$id\"].lastRunAtMs // empty" "$state_file" 2>/dev/null)
                    if [ -n "$last_ms" ]; then
                        last_status=$(jq -r ".[\"$id\"].lastStatus" "$state_file" 2>/dev/null)
                        last_dur_ms=$(jq -r ".[\"$id\"].lastDurationMs" "$state_file" 2>/dev/null)
                        local last_s=$(( last_ms / 1000 ))
                        local ago=$(( now_s - last_s ))
                        local dur_s=$(( last_dur_ms / 1000 ))
                        last_info="$last_status (${dur_s}s, $(format_relative_time $ago))"
                    fi
                fi
                local tag=""
                [ "$enabled" = "false" ] && tag=" [disabled]"
                printf "  %-18s %-20s last: %s%s\n" "$id" "$cron" "$last_info" "$tag"
            done
            echo ""
        fi
    fi

    # Recent activity
    local log_file="$IGLOO_HOME/daemon/listener.log"
    if [ -f "$log_file" ]; then
        local recent
        recent=$(grep -E '(DISPATCH|CLAUDE OK|CLAUDE EXIT|SCHEDULE |SCHEDULE OK|SCHEDULE ERR|BLOCKED|LISTENER START|ERROR)' "$log_file" | tail -8)
        if [ -n "$recent" ]; then
            echo "Recent Activity:"
            while IFS= read -r line; do
                # Extract time (HH:MM) from ISO timestamp and the rest
                local ts msg
                ts=$(echo "$line" | cut -c12-16)
                msg=$(echo "$line" | cut -c26-)
                printf "  %s  %s\n" "$ts" "$msg"
            done <<< "$recent"
            echo ""
        fi
    fi
}

do_logs() {
    tail -f "$IGLOO_HOME/daemon/"*.log
}

do_meeting() {
    # Ensure setup is complete
    if [ ! -f "$IGLOO_HOME/.claude/settings.json" ]; then
        do_setup
    fi

    # Seed skill if missing (for existing installs that haven't re-run setup)
    if [ -d "$CODE_DIR/core/skills/process-meeting" ] && [ ! -d "$IGLOO_HOME/.claude/skills/process-meeting" ]; then
        mkdir -p "$IGLOO_HOME/.claude/skills/process-meeting"
        cp "$CODE_DIR/core/skills/process-meeting/SKILL.md" "$IGLOO_HOME/.claude/skills/process-meeting/SKILL.md"
    fi

    # Ensure intake dir exists
    mkdir -p "$IGLOO_HOME/intake"

    # Clean up any previous result file
    rm -f "$IGLOO_HOME/intake/.last-meeting.json"

    # Run meeting script (clack prompt + editor)
    IGLOO_HOME="$IGLOO_HOME" node "$CODE_DIR/scripts/meeting.js" || return

    # Read the result file
    local result_file="$IGLOO_HOME/intake/.last-meeting.json"
    if [ ! -f "$result_file" ]; then
        echo "  No transcript to process."
        return
    fi

    # Parse the JSON output
    local filepath slug date_str
    filepath=$(jq -r '.filepath' "$result_file")
    slug=$(jq -r '.slug' "$result_file")
    date_str=$(jq -r '.date' "$result_file")
    rm -f "$result_file"

    if [ ! -f "$filepath" ]; then
        echo "  Transcript file not found."
        return
    fi

    echo ""
    echo "  Processing transcript..."
    echo ""

    # Build context and run Claude to process the transcript
    local ctx
    ctx=$(build_context)

    cd "$IGLOO_HOME"
    claude --print -p "${ctx}Process the meeting transcript at $filepath using the /process-meeting skill." \
        --settings "$IGLOO_HOME/.claude/settings.json"

    # Move transcript from intake to transcripts/YYYY-MM-DD/
    local transcript_dir="$IGLOO_HOME/transcripts/$date_str"
    mkdir -p "$transcript_dir"
    mv "$filepath" "$transcript_dir/"

    echo ""
    echo "  Notes saved to memory/meetings/$date_str/"
    echo "  Transcript archived to transcripts/$date_str/"
}

do_chat() {
    banner
    echo ""

    # First run: setup + bootstrap if not done yet
    if [ ! -f "$IGLOO_HOME/.claude/settings.json" ]; then
        do_setup
    fi
    if [ -f "$IGLOO_HOME/core/BOOTSTRAP.md" ]; then
        IGLOO_HOME="$IGLOO_HOME" CODE_DIR="$CODE_DIR" node "$CODE_DIR/scripts/setup.js"
        cd "$IGLOO_HOME"
        local sid
        sid=$(get_session_id)
        claude --session-id "$sid" --chrome \
            "You've just been configured via the setup wizard. Read core/BOOTSTRAP.md and follow its instructions."
        rm -f "$IGLOO_HOME/core/BOOTSTRAP.md"
        (cd "$IGLOO_HOME" && git add -A && git commit -m "Bootstrap complete — removed BOOTSTRAP.md" --quiet 2>/dev/null || true)
        return
    fi

    # Parse flags
    local perms=""
    local here=false
    local args=()
    for arg in "$@"; do
        case "$arg" in
            --danger|--dangerously-skip-permissions) perms="--dangerously-skip-permissions" ;;
            --here|-here) here=true ;;
            --home) here=false ;;
            *) args+=("$arg") ;;
        esac
    done

    # Auto-detect: if outside IGLOO_HOME (not in it or any subdirectory), default to --here
    if [ "$here" = false ]; then
        case "$(pwd)" in
            "$IGLOO_HOME"|"$IGLOO_HOME"/*) ;;  # inside igloo home — stay in local mode
            *) here=true ;;
        esac
    fi

    if [ "$here" = true ]; then
        # Remote mode: stay in current directory, inject igloo's config
        # Resolve the remote code dir from IGLOO_HOME (may differ from local CODE_DIR)
        local remote_code_dir="$CODE_DIR"
        if [ -f "$IGLOO_HOME/.igloo-code-dir" ]; then
            remote_code_dir=$(cat "$IGLOO_HOME/.igloo-code-dir")
        fi

        # Sync igloo skills into local user's .claude/skills via symlinks
        local igloo_skills="$IGLOO_HOME/.claude/skills"
        local local_skills="$HOME/.claude/skills"
        if [ -d "$igloo_skills" ]; then
            mkdir -p "$local_skills"
            for skill_dir in "$igloo_skills"/*/; do
                [ -d "$skill_dir" ] || continue
                local skill_name
                skill_name=$(basename "$skill_dir")
                [ "$skill_name" = "skills" ] && continue
                # Symlink if not already present
                if [ ! -e "$local_skills/$skill_name" ]; then
                    ln -s "$skill_dir" "$local_skills/$skill_name"
                fi
            done
        fi

        # Build system prompt: CLAUDE.md + path remapping + preloaded context
        local sys_prompt=""
        if [ -f "$IGLOO_HOME/CLAUDE.md" ]; then
            sys_prompt+="$(cat "$IGLOO_HOME/CLAUDE.md")"$'\n\n'
        fi
        sys_prompt+="[Igloo Remote Mode] You are running in --here mode. Your home directory is $IGLOO_HOME (not the working directory). All igloo files (memory/, core/, tasks/, workspace/) are at absolute paths under $IGLOO_HOME/. Use absolute paths when reading or writing igloo state."$'\n\n'
        local ctx
        ctx=$(build_context)
        if [ -n "$ctx" ]; then
            sys_prompt+="$ctx"
        fi

        local igloo_flags=(
            --add-dir "$IGLOO_HOME"
            --settings "$IGLOO_HOME/.claude/settings.json"
            --append-system-prompt "$sys_prompt"
        )
        # Load MCP servers (not auto-discovered outside IGLOO_HOME)
        if [ -f "$IGLOO_HOME/.mcp.json" ]; then
            igloo_flags+=(--mcp-config "$IGLOO_HOME/.mcp.json")
        fi

        claude $perms --chrome "${igloo_flags[@]}" "${args[@]+"${args[@]}"}"
    else
        # Local mode: run from IGLOO_HOME (default)
        cd "$IGLOO_HOME"
        claude $perms --chrome "${args[@]+"${args[@]}"}"
    fi
}

# ── Upgrade ───────────────────────────────────────────────────────────────────

do_upgrade() {
    echo "Upgrading Igloo..."
    echo ""

    local old_version="unknown"
    if [ -f "$IGLOO_HOME/.igloo-version" ]; then
        old_version=$(cat "$IGLOO_HOME/.igloo-version")
    fi

    # Stop daemons
    echo "Stopping daemons..."
    listener_stop 2>/dev/null

    # Pull latest code
    echo "Pulling latest code..."
    (cd "$CODE_DIR" && git pull --ff-only)

    # Install dependencies
    echo "Installing dependencies..."
    (cd "$CODE_DIR/mcp" && npm install --silent 2>/dev/null)
    (cd "$CODE_DIR/scripts" && npm install --silent 2>/dev/null)
    (cd "$CODE_DIR/daemon" && npm install --silent 2>/dev/null)

    # Copy CLAUDE.md (always overwrite)
    cp "$CODE_DIR/CLAUDE.md" "$IGLOO_HOME/CLAUDE.md"

    # Regenerate configs
    echo "Regenerating configs..."
    generate_configs

    # Update version
    echo "$CODE_DIR" > "$IGLOO_HOME/.igloo-code-dir"
    if [ -f "$CODE_DIR/VERSION" ]; then
        cp "$CODE_DIR/VERSION" "$IGLOO_HOME/.igloo-version"
    fi

    local new_version="unknown"
    if [ -f "$CODE_DIR/VERSION" ]; then
        new_version=$(cat "$CODE_DIR/VERSION")
    fi

    # Restart daemons
    echo "Restarting daemons..."
    listener_start

    echo ""
    echo "  Upgrade complete: $old_version → $new_version"
    echo "  Home: $IGLOO_HOME"
    echo "  Code: $CODE_DIR"
}

# ── Connect (set up another account to use this igloo) ────────────────────────

do_connect() {
    local target_user="${1:-}"
    if [ -z "$target_user" ]; then
        banner
        echo "Usage: igloo connect <username>"
        echo ""
        echo "  Grant another macOS user access to this igloo."
        echo "  Run this from the igloo account."
        echo ""
        echo "  Example: igloo connect azhar"
        exit 1
    fi

    local target_home="/Users/$target_user"
    if [ ! -d "$target_home" ]; then
        echo "Error: user '$target_user' not found (no $target_home)"
        exit 1
    fi

    banner
    echo "Setting up $target_user to use igloo"
    echo ""

    # 1. Grant write access to IGLOO_HOME (igloo account owns these files)
    echo "  Granting group-write on $IGLOO_HOME..."
    chmod -R g+w "$IGLOO_HOME" 2>/dev/null && echo "  [ok] Write permissions set" || {
        echo "  [!!] Could not set permissions — try:"
        echo "       sudo chmod -R g+w $IGLOO_HOME"
    }

    # 2. Output setup commands for the target user
    echo ""
    echo "  Run these on $target_user's account:"
    echo ""
    echo "    mkdir -p ~/.local/bin"
    echo "    ln -s $CODE_DIR/igloo ~/.local/bin/igloo"
    echo "    echo 'export IGLOO_HOME=$IGLOO_HOME' >> ~/.zshrc"
    echo ""
    echo "  Then open a new terminal and run: igloo"
}

# ── Version ───────────────────────────────────────────────────────────────────

do_version() {
    banner
    echo "  Code: $CODE_DIR"
    echo "  Home: $IGLOO_HOME"
    if [ -f "$IGLOO_HOME/.igloo-version" ]; then
        echo "  Installed: $(cat "$IGLOO_HOME/.igloo-version")"
    fi
}

# ── Main ─────────────────────────────────────────────────────────────────────

case "${1:-}" in
    start)   do_start ;;
    stop)    do_stop ;;
    restart) do_stop; sleep 1; do_start ;;
    status)  do_status ;;
    logs)    do_logs ;;
    meeting) do_meeting ;;
    chat)    shift; do_chat "$@" ;;
    setup)   do_setup ;;
    upgrade) do_upgrade ;;
    connect) shift; do_connect "$@" ;;
    version) do_version ;;
    help)    usage ;;
    -h|--help) usage ;;
    *)       do_chat "$@" ;;
esac
