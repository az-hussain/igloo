#!/bin/bash
set -euo pipefail

IGLOO_DIR="$(cd "$(dirname "$0")" && pwd)"
LISTENER_PID_FILE="$IGLOO_DIR/daemon/listener.pid"
SESSION_ID_FILE="$IGLOO_DIR/.claude/session-id"

TOOLS_FILE="$IGLOO_DIR/.claude/tools.json"

get_session_id() {
    if [ -f "$SESSION_ID_FILE" ]; then
        cat "$SESSION_ID_FILE"
    fi
}

# Check if a tool is enabled in .claude/tools.json
tool_enabled() {
    local tool="$1"
    if [ -f "$TOOLS_FILE" ]; then
        [ "$(jq -r ".$tool.enabled" "$TOOLS_FILE" 2>/dev/null)" = "true" ]
    else
        return 1
    fi
}

# Get tool status from .claude/tools.json
tool_status() {
    local tool="$1"
    if [ -f "$TOOLS_FILE" ]; then
        jq -r ".$tool.status // \"unknown\"" "$TOOLS_FILE" 2>/dev/null
    else
        echo "unknown"
    fi
}

# Rotate a log file to .log.old if > 1MB
rotate_log() {
    local log_file="$1"
    if [ -f "$log_file" ] && [ "$(stat -f%z "$log_file" 2>/dev/null || echo 0)" -gt 1048576 ]; then
        mv "$log_file" "$log_file.old"
    fi
}

# Build context injection string from core files (for fresh sessions)
build_context() {
    local ctx=""
    for f in "$IGLOO_DIR/core/SOUL.md" "$IGLOO_DIR/core/USER.md" "$IGLOO_DIR/memory/MEMORY.md"; do
        if [ -f "$f" ]; then
            ctx+="$(cat "$f")"$'\n\n'
        fi
    done
    if [ -n "$ctx" ]; then
        echo "--- Context ---"$'\n'"$ctx""--- End Context ---"$'\n'
    fi
}

usage() {
    echo "Usage: igloo <command>"
    echo ""
    echo "Commands:"
    echo "  start     Setup (if needed) + start daemons + bootstrap"
    echo "  stop      Stop listener daemon"
    echo "  restart   Restart daemons"
    echo "  status    Show daemon status"
    echo "  logs      Tail daemon logs"
    echo "  chat      Start interactive Claude session (--safe for supervised mode)"
    echo ""
}

# ── Setup (runs once, idempotent) ────────────────────────────────────────────

do_setup() {
    echo "Running first-time setup..."
    echo ""

    # Check dependencies
    local missing=false
    for cmd_info in "claude:Claude Code:npm install -g @anthropic-ai/claude-code" \
                    "node:Node.js:https://nodejs.org" \
                    "git:Git:xcode-select --install" \
                    "imsg:imsg:brew install steipete/tap/imsg"; do
        IFS=: read -r cmd name hint <<< "$cmd_info"
        if command -v "$cmd" &>/dev/null; then
            echo "  [ok] $name"
        else
            echo "  [!!] $name not found — $hint"
            missing=true
        fi
    done
    echo ""

    if [ "$missing" = true ]; then
        read -p "Some dependencies are missing. Continue anyway? (y/N) " -n 1 -r
        echo ""
        [[ $REPLY =~ ^[Yy]$ ]] || exit 1
    fi

    # Create .claude directory (the only one not shipped in the repo)
    mkdir -p "$IGLOO_DIR/.claude"

    # Install dependencies
    echo "Installing dependencies..."
    (cd "$IGLOO_DIR/mcp" && npm install --silent 2>/dev/null)
    (cd "$IGLOO_DIR/scripts" && npm install --silent 2>/dev/null)
    (cd "$IGLOO_DIR/daemon" && npm install --silent 2>/dev/null)

    # Generate configs from templates
    echo "Generating configuration..."
    sed -e "s|__IGLOO_DIR__|$IGLOO_DIR|g" \
        "$IGLOO_DIR/mcp/mcp-config.json.template" > "$IGLOO_DIR/mcp/mcp-config.json"

    sed -e "s|__IGLOO_DIR__|$IGLOO_DIR|g" \
        "$IGLOO_DIR/.claude/settings.json.template" > "$IGLOO_DIR/.claude/settings.json"

    # allowed-senders.json is NOT created here — null/missing means block all.
    # Bootstrap will create it with the user's phone number.

    # Generate persistent session ID (all entry points share one session)
    if [ ! -f "$IGLOO_DIR/.claude/session-id" ]; then
        uuidgen | tr '[:upper:]' '[:lower:]' > "$IGLOO_DIR/.claude/session-id"
    fi

    cp "$IGLOO_DIR/core/TOOLS.md.example" "$IGLOO_DIR/core/TOOLS.md"
    sed -i '' "s|\[filled by setup.sh\]|$IGLOO_DIR|g" "$IGLOO_DIR/core/TOOLS.md"

    # Init git if needed
    if [ ! -d "$IGLOO_DIR/.git" ]; then
        (cd "$IGLOO_DIR" && git init --quiet)
    fi
    (cd "$IGLOO_DIR" && git add -A && git commit -m "Igloo: initial setup" --quiet 2>/dev/null || true)

    echo ""
    echo "  Setup complete."
}

# ── Listener (background process, inherits Terminal FDA) ─────────────────────

listener_stop() {
    if [ -f "$LISTENER_PID_FILE" ]; then
        local pid
        pid=$(cat "$LISTENER_PID_FILE")
        if kill -0 "$pid" 2>/dev/null; then
            kill "$pid" 2>/dev/null
            echo "  Listener stopped (pid $pid)"
        else
            echo "  Listener not running (stale pid)"
        fi
        rm -f "$LISTENER_PID_FILE"
    else
        echo "  Listener not running"
    fi
}

listener_start() {
    listener_stop 2>/dev/null

    rotate_log "$IGLOO_DIR/daemon/listener.log"

    nohup node "$IGLOO_DIR/daemon/listener.js" \
        >> "$IGLOO_DIR/daemon/listener.log" 2>&1 &
    local pid=$!
    echo "$pid" > "$LISTENER_PID_FILE"
    echo "  Listener started (pid $pid, scheduler + iMessage)"
}

listener_status() {
    if [ -f "$LISTENER_PID_FILE" ] && kill -0 "$(cat "$LISTENER_PID_FILE")" 2>/dev/null; then
        echo "  Listener:  running (pid $(cat "$LISTENER_PID_FILE"))"
    else
        echo "  Listener:  stopped"
    fi
}

# ── Daemon management ────────────────────────────────────────────────────────

do_stop() {
    listener_stop
}

do_start() {
    # Run setup if not done yet
    if [ ! -f "$IGLOO_DIR/.claude/settings.json" ]; then
        do_setup
    fi

    local is_bootstrap=false

    # First run: CLI onboarding — collect info, test tools, write configs
    if [ -f "$IGLOO_DIR/core/BOOTSTRAP.md" ]; then
        is_bootstrap=true
        node "$IGLOO_DIR/scripts/setup.js"
    fi

    # Start daemons (scheduler always, iMessage if enabled by setup)
    rotate_log "$IGLOO_DIR/daemon/listener.log"
    listener_start

    # Bootstrap: first conversation with the agent (daemons already running)
    if [ "$is_bootstrap" = true ]; then
        cd "$IGLOO_DIR"
        local sid
        sid=$(get_session_id)
        claude --session-id "$sid" --dangerously-skip-permissions --chrome \
            "You've just been configured via the setup wizard. Read core/BOOTSTRAP.md and follow its instructions."

        rm -f "$IGLOO_DIR/core/BOOTSTRAP.md"
        (cd "$IGLOO_DIR" && git add -A && git commit -m "Bootstrap complete — removed BOOTSTRAP.md" --quiet 2>/dev/null || true)
    fi
}

do_status() {
    echo "Daemons:"
    listener_status
    echo ""
    echo "Logs:"
    for log in "$IGLOO_DIR/daemon/"*.log; do
        if [ -f "$log" ]; then
            echo "  $(basename "$log"): $(wc -l < "$log" | tr -d ' ') lines, $(du -h "$log" | cut -f1)"
        fi
    done
}

do_logs() {
    tail -f "$IGLOO_DIR/daemon/"*.log
}

do_chat() {
    cd "$IGLOO_DIR"

    # --safe flag: run without --dangerously-skip-permissions
    local perms="--dangerously-skip-permissions"
    local args=()
    for arg in "$@"; do
        if [ "$arg" = "--safe" ] || [ "$arg" = "-safe" ]; then
            perms=""
        else
            args+=("$arg")
        fi
    done

    local sid
    sid=$(get_session_id)
    if [ -n "$sid" ] && [ ! -f "$IGLOO_DIR/core/BOOTSTRAP.md" ]; then
        claude --resume "$sid" --fork-session $perms --chrome "${args[@]}"
    else
        local ctx
        ctx=$(build_context)
        if [ -n "$ctx" ]; then
            claude $perms --chrome "$ctx"$'\n'"${args[*]}"
        else
            claude $perms --chrome "${args[@]}"
        fi
    fi
}

# ── Main ─────────────────────────────────────────────────────────────────────

case "${1:-}" in
    start)   do_start ;;
    stop)    do_stop ;;
    restart) do_stop; sleep 1; do_start ;;
    status)  do_status ;;
    logs)    do_logs ;;
    chat)    shift; do_chat "$@" ;;
    setup)   do_setup ;;
    *)       usage ;;
esac
